# Sonatype Central Publishing Setup

This document explains how to set up automatic publishing to Sonatype Central (Maven Central) for the Kai library.

## Overview

The setup includes:
- ✅ Updated `build.gradle.kts` with proper group ID (`io.github.neuraquant`)
- ✅ Added Gradle Nexus Publishing Plugin for simplified publishing
- ✅ Configured GPG signing for Maven Central requirements
- ✅ Created GitHub Actions workflow for automatic publishing on main branch pushes
- ✅ Added setup script for GPG key generation

## Prerequisites

1. **Sonatype Account**: You need a Sonatype account with access to the `io.github.neuraquant` namespace
2. **GitHub Repository**: The repository should be at `https://github.com/NeuraQuant/kai`
3. **GPG**: GPG should be installed on your system

## Setup Steps

### 1. Generate GPG Keys

Run the setup script to generate GPG keys:

```bash
./setup-sonatype.sh
```

This will:
- Generate a new GPG key pair
- Export the private and public keys
- Provide instructions for the next steps

### 2. Upload Public Key to Keyserver

```bash
gpg --send-keys YOUR_KEY_ID
```

### 3. Configure GitHub Secrets

Go to your GitHub repository settings: `https://github.com/NeuraQuant/kai/settings/secrets/actions`

Add the following secrets:

| Secret Name | Value | Description |
|-------------|-------|-------------|
| `SONATYPE_USERNAME` | Your Sonatype username | Username for Sonatype Central |
| `SONATYPE_PASSWORD` | Your Sonatype password/token | Password or token for Sonatype Central |
| `GPG_PRIVATE_KEY` | Contents of `gpg-private-key.asc` | Private GPG key for signing artifacts |
| `GPG_PASSPHRASE` | `sonatype123` (or your chosen passphrase) | Passphrase for the GPG key |

### 4. Upload Public Key to Sonatype

1. Go to [Sonatype Central](https://s01.oss.sonatype.org/)
2. Log in with your credentials
3. Go to "Staging Profiles" and find your profile
4. Click "Access" and then "Upload PGP Key"
5. Upload the `gpg-public-key.asc` file generated by the setup script

### 5. Test the Setup

The workflow will automatically trigger on:
- Any push to the `main` branch
- Manual trigger from the GitHub Actions tab

To test manually:
1. Go to the "Actions" tab in your GitHub repository
2. Select "Publish to Sonatype Central" workflow
3. Click "Run workflow"

## Workflow Details

The GitHub Actions workflow (`/.github/workflows/publish.yml`) performs:

1. **Checkout**: Gets the latest code
2. **Setup Java 17**: Configures the Java environment
3. **Cache Dependencies**: Caches Gradle dependencies for faster builds
4. **Version Validation**: Checks Maven Central to prevent overwriting existing releases
5. **Import GPG Key**: Imports the signing key from GitHub secrets
6. **Publish**: Publishes to Sonatype Central and automatically closes/releases the staging repository

### Version Protection

The workflow includes multiple layers of protection:

- **Pre-publish Validation**: Checks if version already exists in Maven Central
- **Semantic Versioning**: Ensures proper version format
- **SNAPSHOT Handling**: Allows overwriting of development versions
- **Automatic Failure**: Stops publishing if version conflicts are detected

## Build Configuration

The `build.gradle.kts` has been updated with:

- **Group ID**: Changed from `io.kai` to `io.github.neuraquant`
- **Nexus Plugin**: Added `io.github.gradle-nexus.publish-plugin` for simplified publishing
- **Signing**: Configured GPG signing for Maven Central compliance
- **POM Metadata**: Added required metadata for Maven Central

## Artifact Information

Once published, your library will be available at:

- **Group ID**: `io.github.neuraquant`
- **Artifact ID**: `kai`
- **Version**: `1.0.0` (or whatever version is set in `build.gradle.kts`)

Users can add it to their projects with:

```kotlin
dependencies {
    implementation("io.github.neuraquant:kai:1.0.0")
}
```

## Troubleshooting

### Common Issues

1. **GPG Key Issues**: Make sure the GPG key is properly uploaded to both the keyserver and Sonatype
2. **Authentication**: Verify that your Sonatype credentials are correct
3. **Group ID**: Ensure the group ID matches your claimed namespace (`io.github.neuraquant`)
4. **Signing**: Check that the GPG key is properly configured for signing

### Checking Workflow Status

1. Go to the "Actions" tab in your GitHub repository
2. Look for the "Publish to Sonatype Central" workflow
3. Check the logs for any error messages

### Manual Publishing

If you need to publish manually:

```bash
./gradlew publishToSonatype closeAndReleaseSonatypeStagingRepository \
  -Psigning.keyId=YOUR_KEY_ID \
  -Psigning.password=YOUR_PASSPHRASE \
  -PsonatypeUsername=YOUR_USERNAME \
  -PsonatypePassword=YOUR_PASSWORD
```

## Security Notes

- ⚠️ **Never commit private keys to version control**
- ⚠️ **Use strong passphrases in production**
- ⚠️ **Delete the generated key files after setup**
- ⚠️ **Keep your Sonatype credentials secure**

## Support

If you encounter issues:

1. Check the GitHub Actions logs for detailed error messages
2. Verify all secrets are correctly configured
3. Ensure your Sonatype account has the proper permissions
4. Check that the GPG key is properly uploaded to both the keyserver and Sonatype

The workflow is designed to be robust and handle most common scenarios automatically.